import ballerina/grpc;

listener grpc:Listener ep = new (9090);

map<UserInfo> userMap = {};
map<CourseInfo> courseMap = {};
map<Assignments> assignmentMap = {};
map<AssignmentInfo> assInfoMap = {};

@grpc:ServiceDescriptor {descriptor: ROOT_DESCRIPTOR_PB, descMap: getDescriptorMapPb()}
service "Assessment_Management_System" on ep {

    remote function create_assignment(grpc:Caller caller, Assignments value) returns string|error {
        string first_assignment = value.numberOfAssignment;
        assignmentMap[value.numberOfAssignment] = value;

        // Create response message.
        json payload = "Status : assignment Created; desc : " + first_assignment;

        //sending back response
        check caller->send(payload);
        check caller->complete();

        return "caller";
    }
    remote function assign_courses(grpc:Caller caller, CourseInfo value) returns string|error {
        string assign = value.course_name ;
        courseMap[value.course_name ] = value;

        // Create response message.
        json payload = "Status : Course has assigned; CourseDescriptin : " + assign;

        //sending back response
        check caller->send(payload);
        check caller->complete();

        return "caller";
    }
    remote function submit_marks(grpc:Caller caller, AssignmentInfo value) returns string|error {
        string assignmentD = value.iD;
        assInfoMap[value.iD] = value;

        // Create response message.
        string payload = "Status : Marks Submitted; Score: " + assignmentD;

        //sending back response
        check caller->send(payload);
        check caller->complete();

        return "";
    }
    remote function create_users(grpc:Caller caller, stream<UserInfo, grpc:Error?> clientStream) returns string|error {

        string userId = "";
      
        //Iterate through the client stream
        check clientStream.forEach(function(UserInfo value) {

        userId = value.iD; 
        userMap[value.iD] = value; 

        });
        // Create response 
        json payload = "Status : User created; user : " + userId;

        //sending back response
        check caller->send(payload);
        check caller->complete();

        return "";
    }
    remote function create_courses(grpc:Caller caller, stream<CourseInfo, grpc:Error?> clientStream) returns string|error {
        check caller->send("Server is processing......");

        string coursecode = "";
        check clientStream.forEach(function(CourseInfo addCourse) {
    
       // Add the new course to the map.
        coursecode = addCourse.course_code;
        courseMap[addCourse.course_code] = addCourse;
        });

        // Create response message.
       string payload = "Status : Course created; Coursecode : " + coursecode;

        // Send response to the caller.
        
        check caller->send(payload);
        check caller->complete();

        // Send entity not found error.
        payload = "Course : 'with course code "  + coursecode + "' already exist.";

        return "";
    }
    remote function register(grpc:Caller caller, stream<CourseInfo, grpc:Error?> clientStream) returns string|error {
        string courseCode = "";
        string payload;
        
        check clientStream.forEach(function(CourseInfo newRegister) {
            // Find the course that you want to register.
            courseCode = newRegister.course_code; 
            if (courseMap.hasKey(courseCode)) {
                // register for the existing course on the map.
                courseMap[courseCode] = newRegister;
            }

        });
        payload = "Course : '" + courseCode + "' registerd.";
        // Send response to the caller.
        check caller->send(payload);
        check caller->complete();

        return "";
    }
    remote function submit_assignments(grpc:Caller caller, stream<AssignmentInfo, grpc:Error?> clientStream) returns string|error {
        string assignment_id = "";
        string payload;
    
        check clientStream.forEach(function(AssignmentInfo newSubmission) {
        assignment_id = newSubmission.iD;
        assInfoMap[newSubmission.iD] = newSubmission;
        });

         // Create response message.
        payload = "Status : Assignment Submitted; Assessment : " + assignment_id;

        //sending back response
        check caller->send(payload);
        check caller->complete();

        return "";
    }
    remote function request_assignments(grpc:Caller caller, stream<AssignmentInfo, grpc:Error?> clientStream) returns string|error {
        string assignment_description = "";
        string payload;
        
        check clientStream.forEach(function(AssignmentInfo value) {
        
        // Find the course that you want to register.
        assignment_description = value.iD; 
         if (assInfoMap.hasKey(assignment_description)) {
            // register for the existing course on the map.
            assInfoMap[assignment_description] = value;
         }

        });
        payload = "assignment : '" + assignment_description + "' Requested.";
        // Send response to the caller.
        check caller->send(payload);
        check caller->complete();

    }
}
public type AssignmentInfo record {|
    string iD = "";
    string description = "";
    string course_code = "";
    string assignment_mark = "";
|};

public type Assignments record {|
    string numberOfAssignment = "";
    string description = "";
    string weight = "";
|};

public type UserInfo record {|
    string iD = "";
    string name = "";
|};

public type CourseInfo record {|
    string course_code = "";
    string course_name = "";
    UserInfo course_assessor = {};
|};

const string ROOT_DESCRIPTOR_PB = "0A0870622E70726F746F120D61737369676E6D656E743150311A1E676F6F676C652F70726F746F6275662F77726170706572732E70726F746F222E0A0855736572496E666F120E0A0269441801200128095202694412120A046E616D6518022001280952046E616D652290010A0A436F75727365496E666F121F0A0B636F757273655F636F6465180120012809520A636F75727365436F6465121F0A0B636F757273655F6E616D65180220012809520A636F757273654E616D6512400A0F636F757273655F6173736573736F7218032001280B32172E61737369676E6D656E743150312E55736572496E666F520E636F757273654173736573736F7222770A0B41737369676E6D656E7473122E0A126E756D6265724F6641737369676E6D656E7418012001280952126E756D6265724F6641737369676E6D656E7412200A0B6465736372697074696F6E180220012809520B6465736372697074696F6E12160A067765696768741803200128095206776569676874228C010A0E41737369676E6D656E74496E666F120E0A0269441801200128095202694412200A0B6465736372697074696F6E180220012809520B6465736372697074696F6E121F0A0B636F757273655F636F6465180320012809520A636F75727365436F646512270A0F61737369676E6D656E745F6D61726B180420012809520E61737369676E6D656E744D61726B328D050A1C4173736573736D656E745F4D616E6167656D656E745F53797374656D12470A0C6372656174655F757365727312172E61737369676E6D656E743150312E55736572496E666F1A1C2E676F6F676C652E70726F746F6275662E537472696E6756616C75652801124B0A0E6372656174655F636F757273657312192E61737369676E6D656E743150312E436F75727365496E666F1A1C2E676F6F676C652E70726F746F6275662E537472696E6756616C75652801124D0A116372656174655F61737369676E6D656E74121A2E61737369676E6D656E743150312E41737369676E6D656E74731A1C2E676F6F676C652E70726F746F6275662E537472696E6756616C756512490A0E61737369676E5F636F757273657312192E61737369676E6D656E743150312E436F75727365496E666F1A1C2E676F6F676C652E70726F746F6275662E537472696E6756616C756512450A08726567697374657212192E61737369676E6D656E743150312E436F75727365496E666F1A1C2E676F6F676C652E70726F746F6275662E537472696E6756616C7565280112530A127375626D69745F61737369676E6D656E7473121D2E61737369676E6D656E743150312E41737369676E6D656E74496E666F1A1C2E676F6F676C652E70726F746F6275662E537472696E6756616C7565280112540A13726571756573745F61737369676E6D656E7473121D2E61737369676E6D656E743150312E41737369676E6D656E74496E666F1A1C2E676F6F676C652E70726F746F6275662E537472696E6756616C75652801124B0A0C7375626D69745F6D61726B73121D2E61737369676E6D656E743150312E41737369676E6D656E74496E666F1A1C2E676F6F676C652E70726F746F6275662E537472696E6756616C7565620670726F746F33";

public isolated function getDescriptorMapPb() returns map<string> {
    return {"google/protobuf/wrappers.proto": "0A1E676F6F676C652F70726F746F6275662F77726170706572732E70726F746F120F676F6F676C652E70726F746F62756622230A0B446F75626C6556616C756512140A0576616C7565180120012801520576616C756522220A0A466C6F617456616C756512140A0576616C7565180120012802520576616C756522220A0A496E74363456616C756512140A0576616C7565180120012803520576616C756522230A0B55496E74363456616C756512140A0576616C7565180120012804520576616C756522220A0A496E74333256616C756512140A0576616C7565180120012805520576616C756522230A0B55496E74333256616C756512140A0576616C756518012001280D520576616C756522210A09426F6F6C56616C756512140A0576616C7565180120012808520576616C756522230A0B537472696E6756616C756512140A0576616C7565180120012809520576616C756522220A0A427974657356616C756512140A0576616C756518012001280C520576616C756542570A13636F6D2E676F6F676C652E70726F746F627566420D577261707065727350726F746F50015A057479706573F80101A20203475042AA021E476F6F676C652E50726F746F6275662E57656C6C4B6E6F776E5479706573620670726F746F33", "pb.proto": "0A0870622E70726F746F120D61737369676E6D656E743150311A1E676F6F676C652F70726F746F6275662F77726170706572732E70726F746F222E0A0855736572496E666F120E0A0269441801200128095202694412120A046E616D6518022001280952046E616D652290010A0A436F75727365496E666F121F0A0B636F757273655F636F6465180120012809520A636F75727365436F6465121F0A0B636F757273655F6E616D65180220012809520A636F757273654E616D6512400A0F636F757273655F6173736573736F7218032001280B32172E61737369676E6D656E743150312E55736572496E666F520E636F757273654173736573736F7222770A0B41737369676E6D656E7473122E0A126E756D6265724F6641737369676E6D656E7418012001280952126E756D6265724F6641737369676E6D656E7412200A0B6465736372697074696F6E180220012809520B6465736372697074696F6E12160A067765696768741803200128095206776569676874228C010A0E41737369676E6D656E74496E666F120E0A0269441801200128095202694412200A0B6465736372697074696F6E180220012809520B6465736372697074696F6E121F0A0B636F757273655F636F6465180320012809520A636F75727365436F646512270A0F61737369676E6D656E745F6D61726B180420012809520E61737369676E6D656E744D61726B328D050A1C4173736573736D656E745F4D616E6167656D656E745F53797374656D12470A0C6372656174655F757365727312172E61737369676E6D656E743150312E55736572496E666F1A1C2E676F6F676C652E70726F746F6275662E537472696E6756616C75652801124B0A0E6372656174655F636F757273657312192E61737369676E6D656E743150312E436F75727365496E666F1A1C2E676F6F676C652E70726F746F6275662E537472696E6756616C75652801124D0A116372656174655F61737369676E6D656E74121A2E61737369676E6D656E743150312E41737369676E6D656E74731A1C2E676F6F676C652E70726F746F6275662E537472696E6756616C756512490A0E61737369676E5F636F757273657312192E61737369676E6D656E743150312E436F75727365496E666F1A1C2E676F6F676C652E70726F746F6275662E537472696E6756616C756512450A08726567697374657212192E61737369676E6D656E743150312E436F75727365496E666F1A1C2E676F6F676C652E70726F746F6275662E537472696E6756616C7565280112530A127375626D69745F61737369676E6D656E7473121D2E61737369676E6D656E743150312E41737369676E6D656E74496E666F1A1C2E676F6F676C652E70726F746F6275662E537472696E6756616C7565280112540A13726571756573745F61737369676E6D656E7473121D2E61737369676E6D656E743150312E41737369676E6D656E74496E666F1A1C2E676F6F676C652E70726F746F6275662E537472696E6756616C75652801124B0A0C7375626D69745F6D61726B73121D2E61737369676E6D656E743150312E41737369676E6D656E74496E666F1A1C2E676F6F676C652E70726F746F6275662E537472696E6756616C7565620670726F746F33"};
}